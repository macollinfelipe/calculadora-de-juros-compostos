<!-- Adicione logo abaixo do <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> -->
<script>
  function aplicarMascaraMoeda(input) {
    input.addEventListener("input", function () {
      let valor = input.value.replace(/\D/g, "");
      valor = (parseInt(valor) / 100).toFixed(2);
      if (!isNaN(valor)) {
        input.value = Number(valor).toLocaleString("pt-BR", {
          style: "currency",
          currency: "BRL",
        });
      }
    });

    input.addEventListener("blur", function () {
      if (input.value === "") return;
      const valor = parseFloat(input.value.replace(/[^\d,-]/g, "").replace(",", "."));
      input.dataset.value = valor;
    });

    input.addEventListener("focus", function () {
      input.select();
    });
  }

  window.onload = () => {
    const camposMoeda = ["valorAtual", "aporteMensal"];
    camposMoeda.forEach(id => {
      const input = document.getElementById(id);
      aplicarMascaraMoeda(input);
    });
  };

  function formatarValor(valor) {
    return valor.toLocaleString("pt-BR", {
      style: "currency",
      currency: "BRL",
      minimumFractionDigits: 2,
    });
  }

  function calcularAposentadoria() {
    const idadeAtual = parseInt(document.getElementById("idadeAtual").value);
    const idadeAposentadoria = parseInt(document.getElementById("idadeAposentadoria").value);

    const valorAtual = parseFloat(document.getElementById("valorAtual").value.replace(/[^\d,-]/g, "").replace(",", ".")) || 0;
    const aporteMensal = parseFloat(document.getElementById("aporteMensal").value.replace(/[^\d,-]/g, "").replace(",", ".")) || 0;
    const taxaJuros = parseFloat(document.getElementById("taxaJuros").value) / 100;
    const inflacao = parseFloat(document.getElementById("inflacao").value) / 100;

    if (isNaN(idadeAtual) || isNaN(idadeAposentadoria) || isNaN(valorAtual) || isNaN(aporteMensal) || isNaN(taxaJuros) || isNaN(inflacao)) {
      document.getElementById("resultado").innerText = "Preencha todos os campos corretamente!";
      return;
    }

    const anos = idadeAposentadoria - idadeAtual;
    const meses = anos * 12;
    const taxaMensalBruta = Math.pow(1 + taxaJuros, 1 / 12) - 1;
    const taxaMensalInflacao = Math.pow(1 + inflacao, 1 / 12) - 1;
    const taxaReal = ((1 + taxaMensalBruta) / (1 + taxaMensalInflacao)) - 1;

    let montante = valorAtual * Math.pow(1 + taxaReal, meses);

    for (let i = 1; i <= meses; i++) {
      montante += aporteMensal * Math.pow(1 + taxaReal, meses - i);
    }

    const valores = [], aportes = [], juros = [], labels = [];

    for (let i = 0; i <= meses; i += 12) {
      let total = valorAtual * Math.pow(1 + taxaReal, i);
      let totalAportes = valorAtual;

      for (let j = 1; j <= i; j++) {
        total += aporteMensal * Math.pow(1 + taxaReal, i - j);
        totalAportes += aporteMensal;
      }

      const ganhoJuros = total - totalAportes;
      labels.push((idadeAtual + i / 12).toString());
      valores.push(Number(total.toFixed(2)));
      aportes.push(Number(totalAportes.toFixed(2)));
      juros.push(Number(ganhoJuros.toFixed(2)));
    }

    document.getElementById("resultado").innerText = `Montante aos ${idadeAposentadoria} anos corrigido pela inflação: ${formatarValor(montante)}`;
    desenharGrafico(labels, valores, aportes, juros);
  }

  function desenharGrafico(labels, valores, aportes, juros) {
    const ctx = document.getElementById("grafico").getContext("2d");
    if (window.myChart) window.myChart.destroy();

    window.myChart = new Chart(ctx, {
      type: "bar",
      data: {
        labels,
        datasets: [
          {
            label: "Montante Total",
            data: valores,
            backgroundColor: "rgba(40, 167, 69, 0.6)",
            borderColor: "green",
            borderWidth: 1,
          },
          {
            label: "Total Investido",
            data: aportes,
            backgroundColor: "rgba(0, 123, 255, 0.6)",
            borderColor: "#007bff",
            borderWidth: 1,
          },
          {
            label: "Juros Acumulados",
            data: juros,
            backgroundColor: "rgba(255, 193, 7, 0.6)",
            borderColor: "#ffc107",
            borderWidth: 1,
          }
        ]
      },
      options: {
        responsive: true,
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              callback: value => formatarValor(value),
            },
            title: {
              display: true,
              text: 'Valor em Reais'
            }
          }
        },
        plugins: {
          tooltip: {
            callbacks: {
              label: (tooltipItem) => `${tooltipItem.dataset.label}: ${formatarValor(tooltipItem.raw)}`
            }
          }
        }
      },
    });
  }
</script>

